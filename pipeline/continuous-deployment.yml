trigger:
  - main

pr: none

pool:
  name: Azure Pipelines
  vmImage: 'windows-latest'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  # Environment specific variables i.e. azure resource names, are defined in Azure DevOps UI. 

stages:
## -- build app -- ##
  - template: templates/build-app-template.yml
    parameters:
      isDeployRun: true
      stageName: 'BuildApp'
      displayName: 'Build App'
## -- build app -- ##

## -- dev deploy -- ##
  - template: templates/deploy-app-template.yml
    parameters:
      stageName: 'DeployAppDev'
      displayName: 'Deploy App Dev'
      deploymentName: 'devdeploy'
      environment: 'DEV'
      ECE_KEY_VAULT_NAME: '$(kvDev)'
      azureSubscription: '$(subDev)'
      azureResourceGroup: '$(rgDev)'
      sqlServerName: '$(sqlServerDev)'
      webAppName: '$(webAppNameDev)'
## -- dev deploy -- ##

## -- dev cypress tests -- ##
  - template: templates/run-cypress-tests-template.yml
    parameters:
      stageName: 'RunCypressTestsDev'
      displayName: 'Run Cypress Tests Dev'
      cypressApiHost: '$(CYPRESS_API_HOST_DEV)'
      jwtUsername: '$(JWT_USERNAME_DEV)'
      jwtPassword: '$(JWT_PASSWORD_DEV)'
      cypressEnv: 'DEV'
## -- dev cypress tests -- ##

## -- test deploy -- ##
  - template: templates/deploy-app-template.yml
    parameters:
      stageName: 'DeployAppTest'
      displayName: 'Deploy App Test'
      deploymentName: 'testdeploy'
      environment: 'TEST'
      ECE_KEY_VAULT_NAME: 'ece-test-kv-ece'
      azureSubscription: 's203t.azdo.deployment'
      azureResourceGroup: 's203t01-core1'
      sqlServerName: 'ece-test-database'
      webAppName: 'ece-test-as-eligibility-checking-engine'
## -- test deploy -- ##

## -- test cypress tests -- ##
  - template: templates/run-cypress-tests-template.yml
    parameters:
      stageName: 'RunCypressTestsTest'
      displayName: 'Run Cypress Tests Test'
      cypressApiHost: '$(CYPRESS_API_HOST_TEST)'
      jwtUsername: '$(JWT_USERNAME_TEST)'
      jwtPassword: '$(JWT_PASSWORD_TEST)'
      cypressEnv: 'TEST'
## -- test cypress tests -- ##

## -- pp deploy -- ##
  - template: templates/deploy-app-template.yml
    parameters:
      stageName: 'DeployAppPP'
      displayName: 'Deploy App Pre-prod'
      deploymentName: 'ppdeploy'
      environment: 'PRE-PROD'
      ECE_KEY_VAULT_NAME: 'ece-pp-kv-ece'
      azureSubscription: 's203t.azdo.deployment'
      azureResourceGroup: 's203t02-core1'
      sqlServerName: 'ece-pp-database'
      webAppName: 'ece-pp-as-eligibility-checking-engine'
## -- pp deploy -- ##

## -- pp cypress tests -- ##
  - template: templates/run-cypress-tests-template.yml
    parameters:
      stageName: 'RunCypressTestsPp'
      displayName: 'Run Cypress Tests Pre-Prod'
      cypressApiHost: '$(CYPRESS_API_HOST_PP)'
      jwtUsername: '$(JWT_USERNAME_PP)'
      jwtPassword: '$(JWT_PASSWORD_PP)'
      cypressEnv: 'PP'
## -- pp cypress tests -- ##

## -- prod deploy -- ##
  - template: templates/deploy-app-template.yml
    parameters:
      stageName: 'DeployApp'
      displayName: 'Deploy App Production'
      deploymentName: 'deploy'
      environment: 'PROD'
      ECE_KEY_VAULT_NAME: 'ece-kv-ece'
      azureSubscription: 's203p.azdo.deployment'
      azureResourceGroup: 's203p01-core1'
      sqlServerName: 'ece-database'
      webAppName: 'ece-as-eligibility-checking-engine'
## -- prod deploy -- ##
