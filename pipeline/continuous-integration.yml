trigger: none # disable CI trigger i.e. only run on PRs

pr: # enable PR trigger for all branches i.e. run this pipeline on all PR create/updates.
  branches:
    include:
      - '*'

pool:
  name: Azure Pipelines
  vmImage: 'windows-latest'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
## -- build app -- ##
  - template: templates/build-app-template.yml
    parameters:
      isDeployRun: false
      stageName: 'BuildApp'
      displayName: 'Build App'
## -- build app -- ##

  - stage: DeployAppCypress
    displayName: Deploy App Cypress
    jobs:
    - deployment: cypressdeploy
      displayName: Deploy App Cypress
      pool:
        name: Azure Pipelines
        vmImage: 'ubuntu-latest'
      environment: CYPRESS
      strategy:
        runOnce:
          preDeploy:
            steps:
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'current'
                targetPath: '$(Pipeline.Workspace)'
          deploy:
            steps:
              - task: AzureRmWebAppDeployment@4
                inputs:
                  ConnectionType: 'AzureRM'
                  azureSubscription: 's203d.azdo.deployment'
                  appType: 'webApp'
                  WebAppName: 'ece-dev-as-cypress'
                  packageForLinux: '$(Pipeline.Workspace)/checkYourEligibilityAPI/CheckYourEligibility.API.zip'
              - task: Bash@3
                inputs:
                  targetType: inline
                  script: |
                    cd $(Pipeline.Workspace)/checkYourEligibilityAPI/tests
                    npm install
              - task: Bash@3
                displayName: 'RunTests'
                inputs:
                  targetType: inline
                  script: |
                    cd $(Pipeline.Workspace)/checkYourEligibilityAPI/tests
                    export CYPRESS_API_HOST="$(CYPRESS_API_HOST_CYPRESS)"
                    export CYPRESS_JWT_USERNAME=$(JWT_USERNAME_DEV)
                    export CYPRESS_JWT_PASSWORD='$(JWT_PASSWORD_DEV)'
                    export CYPRESS_ENV='DEV'
                    npm run e2e:electron
              - task: Bash@3
                condition: always()
                displayName: 'Generate report'
                inputs:
                  targetType: inline
                  script: |
                    cd $(Pipeline.Workspace)/checkYourEligibilityAPI/tests
                    npm run combine:reports
                    
              - task: PublishBuildArtifacts@1
                displayName: 'Publish Cypress Screenshot Files'
                condition: failed()
                inputs:
                  PathtoPublish: '$(Pipeline.Workspace)/checkYourEligibilityAPI/tests/cypress/screenshots/'
                  ArtifactName: 'screenshots'

              - task: PublishTestResults@2
                condition: always()
                displayName: 'Publish test results'
                inputs:
                  testResultsFiles: '**/combined-report.xml'
                  searchFolder: '$(Pipeline.Workspace)/checkYourEligibilityAPI/tests'
